<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.3/dist/instantsearch.min.css">
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.3/dist/instantsearch.min.js">
<!-- Always use `2.x` versions in production rather than `2` to mitigate any side effects on your website,
Find the latest version on InstantSearch.js website: https://community.algolia.com/instantsearch.js/v2/guides/usage.html -->
</script>
<script src="https://cdn.jsdelivr.net/jquery/3.2.1/jquery.min.js"></script>


<div class="page-header courses">
  <div class="page-header-overlay">
    <div class="container w-container">
      <h2 data-ix="fade-in-on-load" class="page-header-title">Liste des propositions du mois à venir</h2>
      <h2 data-ix="fade-in-on-load-2" class="page-subtitle">Pour danser et s'épanouir à Paris</h2>
    </div>
  </div>
</div>
<div class="section">
  <div class="container w-container">
    <div>
        <div id="search-bar" style= "display: flex; justify-content: center; margin:auto">
          <div style="width: 600px;">
            <input type="text" class="form-control" id="search-box" style="width: 70vw"></input>
            <div style="color: grey; text-align: right !important" >Moteur de recherche : <%= link_to "Algolia", "https://www.algolia.com/", target: "_blank" %> </div>
          </div>
        </div>
      <%= link_to "Ajouter une proposition", new_event_path, class: "button submit-button w-button", style: "font-size: 100%; width:237px; margin:auto "%>
    </div>
    </br>
    </br>
    </br>
    <div class="content">
      <div class="container w-container">
        <div class="w-dyn-list">
          <div class="w-clearfix w-dyn-items">
            <div class="courses-list-item w-dyn-item">
              <!-- hits-container ALGOLIA -->
              <div id="hits-container"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@1/dist/instantsearch.min.js"></script>

<script>
  // Configuration for Algolia
  var search = instantsearch({
    apiKey: '<%= ENV['ALGOLIA_SEARCH_API_KEY_SEARCH'] %>',
    appId: '<%= ENV['ALGOLIA_SEARCH_APPLICATION_ID'] %>',
    indexName: 'Event',
    searchParameters: {
      filters: 'unix_begin_at > <%= Time.now.to_i %>'
    }
  });
  search.addWidget(
    instantsearch.widgets.searchBox({
      container: '#search-box',
      placeholder: 'Entrez vos mots de recherche (ex: "danse mouvement paris") ...',
      autofocus: true
    })
  );

// Render template new version *****************************************************************

var readyToFetchMore = true;

var hitsContainer = $('#hits-container');

search.addWidget(
  {
    init: function (params) {
      params.helper.setQueryParameter('hitsPerPage', 10);

      function scrollhandler() {

        var isAtBottomOfPage = $(window).scrollTop() + $(window).height()
                                > $(document).height() - 500;

        if (readyToFetchMore && isAtBottomOfPage) {
          readyToFetchMore = false;
          params.helper.nextPage().search();
        }
      }

      $(window).bind("scroll", scrollhandler);
    },

    render: function (params) {

      readyToFetchMore = true;

      var hits = params.results.hits;


      if (params.state.page === 0) { // because '0' means we changed the query
        hitsContainer.html('');
      }

      var html = '';

      if (params.results.nbHits > 0) {

        html = hits.map(function (hit) {

          return ''
                +'  <a href=\"' + hit.url + '\" >'
                +'    <div class=\"course-block-wrapper list-view w-clearfix\">'
                +'      <div class=\"course-image-link-block list-view w-inline-block\"  style=\"background-image:url(' + hit.image_url + ')\" >'
                +'        <div class=\"image-overlay-block\"></div>'
                +'      </div>'
                +'      <div class=\"featured-label\">' + hit.category_name + '</div>'
                +'      <div class=\"course-content-block list-view\"><div class=\"course-title-link list-view\" >' + hit.title + '</div></div>'
                +'      <div class=\"course-content-block _2 list-view\"><img class=\"teacher-overlay-photo list-view-photo w-hidden-tiny\" src=' + hit.member_avatar + '>'
                +'        <div class=\"teacher-overlay-title list-view w-hidden-tiny\">' + hit.member_pseudo + '</div>'
                +'        <div class="course-info-icon"></div>'
                +'        <div class="event-info-title">' + hit.show_begin_at + '</div>'
                +'        <div class="course-info-icon"></div>'
                +'        <div class="event-info-title">' + hit.zip + ' ' + hit.city + '</div>'
                +'      </div>'
                +'    </div>'
                +' </a>'




                +' ';

        });

      } else {
          html = ['No results ici'];
      }

      hitsContainer.append(html.join(''));
    }
  }
);


  // Start search function
  search.start();
</script>
